sap.ui.define(["sap/ui/core/mvc/Controller","sap/m/MessageToast","sap/m/Dialog","sap/m/Button","sap/m/Input","sap/m/VBox","sap/m/MessageBox"],function(e,t,o,n,a,l,r){"use strict";return e.extend("project2.controller.View1",{onInit:async function(){let e=await this.getDatafromTable();this.localModel=new sap.ui.model.json.JSONModel;this.getView().setModel(this.localModel,"localModel");this.localModel.setData({items:e});console.log("---------",this.localModel)},getDatafromTable:async function(){const e=this;return new Promise((o,n)=>{let a=e.getOwnerComponent().getModel().getServiceUrl()+"excelFile";$.ajax({url:a,method:"GET",contentType:"application/json",success:function(e,t,n){console.log("Retrieve data successful");console.log(e.value);o(e.value)},error:function(e,o,a){t.show("Retrieve data failed");n(a)}})})},handleFileUploadPressed:function(e){let t=e.getParameters("file").files[0];let o=e.getParameters("file").files[0].name;let n=e.getParameters("file").files[0].type;this._import(t)},readFileAsBase64:function(e){var o=new FileReader;var n=this;o.onload=function(o){var a=o.target.result.split(",")[1];t.show("Base64 representation: "+a);let l=n.getOwnerComponent().getModel().getServiceUrl()+"files";let r=Math.floor(Math.random()*(1-1e3+1))+1e3;let s={fileId:r,fileName:e.name,fileType:e.type,base64Data:a};$.ajax({url:l,method:"POST",contentType:"application/json",data:JSON.stringify(s),success:function(e,o,n){t.show("Upload successful")},error:function(e,o,n){t.show("Upload failed")}})};o.readAsDataURL(e)},_import:function(e){var t=this;let o={};if(e&&window.FileReader){var n=new FileReader;n.onload=function(e){var n=e.target.result;var a=XLSX.read(n,{type:"binary"});a.SheetNames.forEach(function(e){o=XLSX.utils.sheet_to_row_object_array(a.Sheets[e])});console.log("show:",o);t.addToExcelDataTable(o)};n.onerror=function(e){console.log(e)};n.readAsBinaryString(e)}},addToExcelDataTable:function(e){let o=this.getOwnerComponent().getModel().getServiceUrl()+"excelFile";e.forEach(e=>{let n={exId:Number(e.id),exEmail:e.email,exFirst_name:e.first_name,exLast_name:e.last_name,exAvatar:e.avatar};$.ajax({url:o,method:"POST",contentType:"application/json",data:JSON.stringify(n),success:function(e,o,n){t.show("Upload successful");var a=this.getView().byId("idExcelDataTable");a.getModel("localModel").refresh(true)},error:function(e,o,n){t.show("Upload failed")}})})},handleEditButtonPressed:function(e){const l=this;var s=this.getView().byId("idExcelDataTable");var i=s.getSelectedItems();if(i.length===1){var c=i[0];var d=c.getBindingContext("localModel");var u=d.getProperty();console.log("Selected Row Data:",u)}else{r.warning("Please select a single row for editing.")}let g=u.exId;var f=new o({title:"Edit Details",content:[new a({placeholder:"Field 1",value:u.exFirst_name}),new a({placeholder:"Field 2",value:u.exLast_name}),new a({placeholder:"Field 3",value:u.exEmail}),new a({placeholder:"Field 4",value:u.exAvatar})],beginButton:new n({text:"Submit",press:function(){var e={exEmail:f.getContent()[2].getValue(),exFirst_name:f.getContent()[0].getValue(),exLast_name:f.getContent()[1].getValue(),exAvatar:f.getContent()[3].getValue()};let o=l.getOwnerComponent().getModel().getServiceUrl()+"excelFile";$.ajax({url:`${o}(${g})`,method:"PATCH",contentType:"application/json",data:JSON.stringify(e),success:function(o){console.log("Entity updated successfully:",o);t.show("Entity updated successfully");var n=l.localModel.getProperty("/items");var a=n.find(e=>e.exId===g);if(a){a.exEmail=e.exEmail;a.exFirst_name=e.exFirst_name;a.exLast_name=e.exLast_name;a.exAvatar=e.exAvatar}s.getModel("localModel").refresh(true)},error:function(e){console.error("Error updating entity:",e)}});f.close()}}),endButton:new n({text:"Cancel",press:function(){f.close()}}),afterClose:function(){f.destroy()}});f.open()},handleAddButtonPressed:function(e){const l=this;var s=new o({title:"Add Details",content:[new a({placeholder:"Id"}),new a({placeholder:"Email"}),new a({placeholder:"First name"}),new a({placeholder:"Second Name"}),new a({placeholder:"avatar"})],beginButton:new n({text:"Submit",press:function(){var e={exId:Number(s.getContent()[0].getValue()),exEmail:s.getContent()[1].getValue(),exFirst_name:s.getContent()[2].getValue(),exLast_name:s.getContent()[3].getValue(),exAvatar:s.getContent()[4].getValue()};let o=l.getOwnerComponent().getModel().getServiceUrl()+"excelFile";$.ajax({url:o,method:"POST",contentType:"application/json",data:e,success:function(e){console.log("Entity updated successfully:",e);t.show("Entity insertion successfully");oTable.getModel("localModel").refresh(true)},error:function(e){r.error("Error inserting entity:",e)}});s.close()}}),endButton:new n({text:"Cancel",press:function(){s.close()}}),afterClose:function(){s.destroy()}});s.open()},onDeleteAllRecords:function(e){const t=this;let o=t.getOwnerComponent().getModel().getServiceUrl()+"excelFile";$.ajax({url:o,method:"DELETE",contentType:"application/json",success:function(e,t,o){r.success("All records deleted successfully")},error:function(e,t,o){r.error("Error deleting records");console.log("errorThrown: ",o)}})}})});